<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <th:block th:replace="~{shared/fragments/head :: head}"></th:block>
    <title>Quản Lý Orders | Admin</title>
  </head>
  <body class="admin-body">
    <th:block th:replace="~{shared/fragments/admin-sidebar :: admin-sidebar}"></th:block>

    <main class="admin-main">
      <div class="admin-header">
        <h1>Quản Lý Orders</h1>
        <div class="admin-user">
          <img th:src="@{/assets/img/avatar.jpg}" alt="" class="admin-user__avatar" />
          <span th:text="${session.user.fullName}">Admin</span>
        </div>
      </div>

      <div class="admin-content">
        <div class="table-card">
          <div class="table-card__header">
            <input type="text" id="searchInput" placeholder="Tìm mã đơn hàng..." class="search-input" />
            <select id="statusFilter" class="filter-select" onchange="loadOrders()">
              <option value="">Tất cả trạng thái</option>
              <option value="PENDING">Chờ xác nhận</option>
              <option value="CONFIRMED">Đã xác nhận</option>
              <option value="PROCESSING">Đang xử lý</option>
              <option value="SHIPPED">Đang giao</option>
              <option value="DELIVERED">Đã giao</option>
              <option value="CANCELLED">Đã hủy</option>
            </select>
          </div>

          <div class="table-responsive">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Mã ĐH</th>
                  <th>Khách Hàng</th>
                  <th>Ngày Đặt</th>
                  <th>Tổng Tiền</th>
                  <th>Thanh Toán</th>
                  <th>Trạng Thái</th>
                  <th>Hành Động</th>
                </tr>
              </thead>
              <tbody id="ordersTable">
                <tr><td colspan="7" class="text-center">Đang tải...</td></tr>
              </tbody>
            </table>
          </div>

          <div class="pagination" id="pagination"></div>
        </div>
      </div>
    </main>

    <!-- Update Status Modal -->
    <div id="statusModal" class="modal" style="display:none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Cập Nhật Trạng Thái</h2>
          <button onclick="closeModal()" class="modal-close">&times;</button>
        </div>
        <form id="statusForm" onsubmit="updateStatus(event)">
          <input type="hidden" id="orderId" />
          <div class="form-group">
            <label>Trạng thái mới</label>
            <select id="newStatus" class="form-control" required>
              <option value="CONFIRMED">Xác nhận</option>
              <option value="PROCESSING">Đang xử lý</option>
              <option value="SHIPPED">Đang giao</option>
              <option value="DELIVERED">Đã giao</option>
              <option value="CANCELLED">Hủy</option>
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" onclick="closeModal()" class="btn btn--outline">Hủy</button>
            <button type="submit" class="btn btn--primary">Cập nhật</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      let currentPage = 0;

      document.addEventListener('DOMContentLoaded', loadOrders);

      function loadOrders() {
        const status = document.getElementById('statusFilter').value;
        let url = `/api/orders/paginated?page=${currentPage}&size=20`;
        if (status) url += `&status=${status}`;

        fetch(url)
          .then(r => r.json())
          .then(data => {
            const tbody = document.getElementById('ordersTable');
            if (data.content && data.content.length > 0) {
              tbody.innerHTML = data.content.map(order => `
                <tr>
                  <td><strong>${order.orderNumber}</strong></td>
                  <td>${order.userName || 'N/A'}</td>
                  <td>${new Date(order.createdAt).toLocaleDateString('vi-VN')}</td>
                  <td>${new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'}).format(order.totalAmount)}</td>
                  <td><span class="badge badge--${order.paymentStatus.toLowerCase()}">${order.paymentStatus}</span></td>
                  <td><span class="badge badge--${order.status.toLowerCase()}">${order.status}</span></td>
                  <td>
                    <button onclick="viewOrder(${order.id})" class="btn btn--small">Xem</button>
                    <button onclick="showStatusModal(${order.id}, '${order.status}')" class="btn btn--small btn--primary">Cập nhật</button>
                  </td>
                </tr>
              `).join('');
            } else {
              tbody.innerHTML = '<tr><td colspan="7" class="text-center">Không có đơn hàng</td></tr>';
            }
          })
          .catch(e => {
            console.error(e);
            document.getElementById('ordersTable').innerHTML = 
              '<tr><td colspan="7" class="text-center">Lỗi tải dữ liệu</td></tr>';
          });
      }

      function viewOrder(id) {
        window.location.href = `/order-detail/${id}`;
      }

      function showStatusModal(id, currentStatus) {
        document.getElementById('orderId').value = id;
        document.getElementById('newStatus').value = currentStatus;
        document.getElementById('statusModal').style.display = 'flex';
      }

      function closeModal() {
        document.getElementById('statusModal').style.display = 'none';
      }

      function updateStatus(e) {
        e.preventDefault();
        const id = document.getElementById('orderId').value;
        const status = document.getElementById('newStatus').value;

        fetch(`/api/orders/${id}/status?status=${status}`, {method: 'PUT'})
          .then(r => r.json())
          .then(() => {
            alert('Đã cập nhật trạng thái');
            closeModal();
            loadOrders();
          })
          .catch(e => alert('Có lỗi xảy ra'));
      }
    </script>

    <style>
      .admin-body{margin:0;padding:0;background:#f5f7fa;font-family:system-ui,-apple-system,sans-serif}
      .admin-main{margin-left:260px;min-height:100vh;padding:0}
      .admin-header{background:#fff;padding:20px 32px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center}
      .admin-header h1{margin:0;font-size:24px}
      .admin-user{display:flex;align-items:center;gap:12px}
      .admin-user__avatar{width:40px;height:40px;border-radius:50%}
      .admin-content{padding:32px}
      .table-card{background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
      .table-card__header{display:flex;gap:16px;margin-bottom:20px}
      .search-input,.filter-select{padding:10px 16px;border:1px solid #e0e0e0;border-radius:8px;font-size:14px}
      .search-input{flex:1}
      .filter-select{min-width:150px}
      .table-responsive{overflow-x:auto}
      .admin-table{width:100%;border-collapse:collapse}
      .admin-table th{text-align:left;padding:12px;border-bottom:2px solid #e0e0e0;font-weight:600;color:#666;font-size:14px}
      .admin-table td{padding:12px;border-bottom:1px solid #f0f0f0;font-size:14px}
      .badge{padding:4px 12px;border-radius:12px;font-size:12px;font-weight:500}
      .badge--pending{background:#fff3cd;color:#856404}
      .badge--confirmed{background:#d1ecf1;color:#0c5460}
      .badge--processing{background:#cce5ff;color:#004085}
      .badge--shipped{background:#d1ecf1;color:#0c5460}
      .badge--delivered{background:#d4edda;color:#155724}
      .badge--cancelled{background:#f8d7da;color:#721c24}
      .badge--paid{background:#d4edda;color:#155724}
      .badge--pending{background:#fff3cd;color:#856404}
      .btn--small{padding:6px 12px;font-size:13px;background:#77dae6;color:#fff;border:none;border-radius:6px;cursor:pointer;margin-right:4px}
      .btn--primary{background:#3b82f6}
      .text-center{text-align:center}
      .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1000}
      .modal-content{background:#fff;border-radius:12px;width:90%;max-width:400px}
      .modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid #e0e0e0}
      .modal-close{background:none;border:none;font-size:28px;cursor:pointer}
      .modal-footer{display:flex;gap:12px;justify-content:flex-end;padding:20px;border-top:1px solid #e0e0e0}
      .form-group{padding:20px}
      .form-group label{display:block;margin-bottom:8px;font-weight:500}
      .form-control{width:100%;padding:10px;border:1px solid #e0e0e0;border-radius:8px}
      .btn--outline{background:#fff;border:1px solid #e0e0e0;color:#333}
      @media (max-width:768px){.admin-main{margin-left:0}}
    </style>
  </body>
</html>
