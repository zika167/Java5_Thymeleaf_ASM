<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng - Fat C Grocery Store</title>
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <!-- Header -->
    <div th:replace="~{shared/shared/fragments/header :: header}"></div>

    <!-- Main Content -->
    <main class="cart-page">
        <div class="container">
            <div class="breadcrumbs">
                <a href="/">Trang chủ</a>
                <span>/</span>
                <span>Giỏ hàng</span>
            </div>

            <h1 class="page-title">Giỏ hàng của bạn</h1>

            <!-- Empty Cart State -->
            <div id="empty-cart" class="empty-cart" style="display: none;">
                <img src="/assets/icon/bag.svg" alt="Empty cart" class="empty-cart__icon">
                <h2>Giỏ hàng trống</h2>
                <p>Bạn chưa có sản phẩm nào trong giỏ hàng</p>
                <a href="/" class="btn btn--primary">Tiếp tục mua sắm</a>
            </div>

            <!-- Cart Content -->
            <div id="cart-content" class="cart-content">
                <div class="cart-items" id="cart-items">
                    <!-- Cart items will be loaded here via JavaScript -->
                </div>

                <div class="cart-summary">
                    <h3>Tổng đơn hàng</h3>
                    <div class="cart-summary__row">
                        <span>Tạm tính:</span>
                        <span id="subtotal">0 đ</span>
                    </div>
                    <div class="cart-summary__row">
                        <span>Phí vận chuyển:</span>
                        <span id="shipping">Miễn phí</span>
                    </div>
                    <div class="cart-summary__row cart-summary__total">
                        <span>Tổng cộng:</span>
                        <span id="total">0 đ</span>
                    </div>
                    <a href="/checkout" class="btn btn--primary btn--full">Tiến hành thanh toán</a>
                    <a href="/" class="btn btn--secondary btn--full">Tiếp tục mua sắm</a>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div th:replace="~{shared/fragments/footer :: footer}"></div>

    <script>
        // Load cart data
        async function loadCart() {
            try {
                const response = await fetch('/api/cart');
                const data = await response.json();

                if (data.totalItems === 0) {
                    document.getElementById('empty-cart').style.display = 'block';
                    document.getElementById('cart-content').style.display = 'none';
                    return;
                }

                document.getElementById('empty-cart').style.display = 'none';
                document.getElementById('cart-content').style.display = 'flex';

                renderCartItems(data.items);
                updateCartSummary(data);
            } catch (error) {
                console.error('Error loading cart:', error);
            }
        }

        // Render cart items
        function renderCartItems(items) {
            const container = document.getElementById('cart-items');
            container.innerHTML = items.map(item => `
                <div class="cart-item" data-id="${item.id}">
                    <img src="${item.productImage || '/assets/img/product/default.jpg'}" alt="${item.productName}" class="cart-item__image">
                    <div class="cart-item__info">
                        <h3 class="cart-item__name">${item.productName}</h3>
                        <p class="cart-item__price">${formatPrice(item.price)}</p>
                    </div>
                    <div class="cart-item__quantity">
                        <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${item.quantity - 1})">-</button>
                        <input type="number" value="${item.quantity}" min="1" readonly>
                        <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
                    </div>
                    <div class="cart-item__subtotal">
                        ${formatPrice(item.subtotal)}
                    </div>
                    <button class="cart-item__remove" onclick="removeItem(${item.id})">
                        <img src="/assets/icon/trash.svg" alt="Remove">
                    </button>
                </div>
            `).join('');
        }

        // Update cart summary
        function updateCartSummary(data) {
            document.getElementById('subtotal').textContent = formatPrice(data.totalPrice);
            document.getElementById('total').textContent = formatPrice(data.totalPrice);
        }

        // Update quantity
        async function updateQuantity(itemId, newQuantity) {
            if (newQuantity < 1) return;

            try {
                const response = await fetch('/api/cart/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cartItemId: itemId,
                        quantity: newQuantity
                    })
                });

                if (response.ok) {
                    loadCart();
                } else {
                    const error = await response.json();
                    alert(error.message || 'Không thể cập nhật số lượng');
                }
            } catch (error) {
                console.error('Error updating quantity:', error);
                alert('Đã xảy ra lỗi khi cập nhật số lượng');
            }
        }

        // Remove item
        async function removeItem(itemId) {
            if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) return;

            try {
                const response = await fetch(`/api/cart/remove/${itemId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadCart();
                } else {
                    alert('Không thể xóa sản phẩm');
                }
            } catch (error) {
                console.error('Error removing item:', error);
                alert('Đã xảy ra lỗi khi xóa sản phẩm');
            }
        }

        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }

        // Load cart on page load
        document.addEventListener('DOMContentLoaded', loadCart);
    </script>

    <style>
        .cart-page { padding: 40px 0; }
        .page-title { font-size: 32px; margin-bottom: 30px; }
        .empty-cart { text-align: center; padding: 60px 20px; }
        .empty-cart__icon { width: 100px; height: 100px; opacity: 0.3; margin-bottom: 20px; }
        .cart-content { display: flex; gap: 30px; }
        .cart-items { flex: 1; }
        .cart-item { display: flex; align-items: center; gap: 20px; padding: 20px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 15px; }
        .cart-item__image { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; }
        .cart-item__info { flex: 1; }
        .cart-item__name { font-size: 18px; margin-bottom: 8px; }
        .cart-item__price { color: #4CAF50; font-weight: bold; }
        .cart-item__quantity { display: flex; align-items: center; gap: 10px; }
        .quantity-btn { width: 32px; height: 32px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
        .quantity-btn:hover { background: #f5f5f5; }
        .cart-item__quantity input { width: 60px; text-align: center; border: 1px solid #ddd; padding: 8px; border-radius: 4px; }
        .cart-item__subtotal { font-weight: bold; min-width: 120px; text-align: right; }
        .cart-item__remove { background: none; border: none; cursor: pointer; padding: 8px; }
        .cart-item__remove:hover { opacity: 0.7; }
        .cart-summary { width: 350px; padding: 20px; border: 1px solid #eee; border-radius: 8px; height: fit-content; position: sticky; top: 20px; }
        .cart-summary h3 { margin-bottom: 20px; }
        .cart-summary__row { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .cart-summary__total { font-size: 20px; font-weight: bold; padding-top: 15px; border-top: 2px solid #eee; margin-top: 15px; }
        .btn { display: inline-block; padding: 12px 24px; text-decoration: none; border-radius: 8px; text-align: center; cursor: pointer; border: none; font-size: 16px; }
        .btn--primary { background: #4CAF50; color: white; }
        .btn--primary:hover { background: #45a049; }
        .btn--secondary { background: white; color: #333; border: 1px solid #ddd; }
        .btn--secondary:hover { background: #f5f5f5; }
        .btn--full { width: 100%; margin-top: 10px; }
    </style>
</body>
</html>
